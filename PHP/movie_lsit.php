<?php
// ========================================
// movies_list.php: 특정 스튜디오가 제작한 영화 목록 표시
// ========================================
// 목적: 2.php에서 전달받은 스튜디오 이름으로
//       해당 스튜디오가 제작한 모든 영화 목록 표시
// 접근 방법: 2.php의 "제작한 영화수" 링크 클릭 시 이동
// URL 형식: movies_list.php?name=스튜디오이름
// ========================================

// ===== 한글 인코딩 설정 (선택사항) =====
// Oracle 데이터베이스의 한글 데이터를 올바르게 처리하기 위한 환경 변수
//putenv("NLS_LANG=KOREAN_KOREA.AL32UTF8");

// ===== 에러 처리 함수 =====
/**
 * Oracle 에러 메시지를 출력하고 스크립트 종료
 * 
 * @param resource|null $id - OCI 리소스 핸들 (connection 또는 statement)
 *                           null인 경우 전역 에러 확인
 */
function p_error($id=null){
    if($id == null) 
        $e = oci_error();      // 전역 에러 (주로 연결 실패)
    else 
        $e = oci_error($id);   // 특정 리소스의 에러 (파싱, 실행 실패 등)
    
    // HTML 특수문자를 엔티티로 변환하여 안전하게 출력
    print htmlentities($e['message']);
    exit();  // 스크립트 즉시 종료
}

// ===== 데이터베이스 연결 =====
// Oracle 데이터베이스에 연결
$conn = oci_connect("db2021663028","db88602924", "localhost/lecture");

// 연결 실패 시 에러 처리
if(!$conn) p_error();

// ===== GET 파라미터 수신 =====
// URL에서 전달된 스튜디오 이름 가져오기
// 예: movies_list.php?name=Universal → $_GET["name"] = "Universal"
$studio_name = $_GET["name"];

// ===== SQL 인젝션 방지 처리 =====
// 스튜디오 이름에 작은따옴표(')가 있는 경우 두 개('')로 이스케이프
// 예: "Warner's" → "Warner''s"
// 이유: SQL 쿼리에서 문자열을 작은따옴표로 감싸므로 충돌 방지
// 중요: SQL 인젝션 공격 방지
$studio_name2 = str_replace("'", "''", $studio_name);

// ===== 영화 목록 조회 쿼리 =====
$stmt = oci_parse($conn,
    // SELECT 절: 영화 제목, 연도, 상영시간, 제작자 이름
    "select m.title, m.year, m.length, e.name producer ".
    // FROM 절: movie와 movieexec 테이블 조인
    "from movie m, movieexec e ".
    // WHERE 절: 
    //   1. 특정 스튜디오가 제작한 영화만 필터링
    //   2. 제작자(프로듀서) 정보 조인
    "where m.studioname = '$studio_name2' ".
    "and m.producerno = e.certno ".
    // ORDER BY 절: 개봉 연도 순, 같은 연도면 제목 순으로 정렬
    "order by m.year, m.title");

// 파싱 실패 시 에러 처리
if(!$stmt) p_error($conn);

// ===== 쿼리 실행 =====
$r = oci_execute($stmt);

// 실행 실패 시 에러 처리
if(!$r) p_error($conn);

// ===== 페이지 제목 출력 =====
// 스튜디오 이름을 포함한 제목 (H2 헤더)
// 예: "Universal 제작 영화 목록"
print "<h2>$studio_name 제작 영화 목록</h2>\n";

// ===== HTML 테이블 헤더 출력 =====
// 핑크색 배경, 1픽셀 테두리, 3픽셀 셀 간격의 테이블 시작
print "<TABLE bgcolor='pink' border=1 cellspacing=3>\n";

// 빨간색 배경의 헤더 행 (중앙 정렬)
print "<TR bgcolor='red' align=center><TH>제목<TH>개봉년도<TH>상영시간<TH>제작자</TR>\n";

// ===== 영화 카운터 초기화 =====
// 조회된 영화 수를 세기 위한 변수
// 목적: 영화가 없는 경우 "제작한 영화가 없습니다" 메시지 표시
$cnt = 0;

// ===== 메인 루프: 각 영화 정보 출력 =====
while($row = oci_fetch_array($stmt)){
    // 영화 수 증가
    $cnt++;
    
    // 영화 정보 행 출력
    // $row[0]: 제목
    // $row[1]: 연도
    // $row[2]: 상영시간
    // $row[3]: 제작자 이름
    print "<TR><TD>{$row[0]}<TD>{$row[1]}년<TD>{$row[2]}분<TD>{$row[3]}</TR>\n";
}

// ===== 영화 없음 처리 =====
// 조회된 영화가 하나도 없는 경우
if($cnt == 0){
    // 테이블에 메시지 행 추가
    // colspan=4: 4개 컬럼을 병합하여 메시지 표시
    print "<TR><TD colspan=4>제작한 영화가 없습니다.</TD></TR>\n";
}

// ===== 테이블 종료 =====
print "</TABLE>\n";

// ===== 리소스 정리 =====
// 쿼리 리소스 해제
oci_free_statement($stmt);

// 데이터베이스 연결 종료
oci_close($conn);

?>

<!-- 
========================================
페이지 출력 예시 1: 영화가 있는 경우
========================================

Universal 제작 영화 목록

+----------------+----------+----------+----------+
| 제목           | 개봉년도 | 상영시간 | 제작자   |
+----------------+----------+----------+----------+
| Jurassic Park  | 1993년   | 127분    | Steven   |
| Jaws           | 1975년   | 124분    | Richard  |
| E.T.           | 1982년   | 115분    | Steven   |
+----------------+----------+----------+----------+

========================================
페이지 출력 예시 2: 영화가 없는 경우
========================================

NewStudio 제작 영화 목록

+---------------------------------------+
| 제작한 영화가 없습니다.                |
+---------------------------------------+

========================================
페이지 흐름:
========================================

[2.php - 메인 페이지]
    ↓ (제작 영화 수 클릭)
[movies_list.php] ← 현재 페이지
    - URL: ?name=스튜디오이름
    - 해당 스튜디오의 영화 목록 표시

========================================
주요 기능:
========================================
1. GET 파라미터로 스튜디오 이름 수신
2. 해당 스튜디오가 제작한 영화만 필터링
3. 영화를 연도순, 제목순으로 정렬하여 표시
4. 제작자(프로듀서) 정보 함께 표시
5. 영화가 없는 경우 적절한 메시지 표시
6. SQL 인젝션 방지 처리

========================================
보안 고려사항:
========================================
1. SQL 인젝션 방지:
   - str_replace("'", "''", $studio_name)
   - 작은따옴표 이스케이프 처리
   
2. 향후 개선 권장사항:
   - Prepared Statement (바인드 변수) 사용
   - 예: "where m.studioname = :name"
   - oci_bind_by_name() 함수 사용

3. XSS 방지:
   - 현재: $studio_name을 직접 출력
   - 권장: htmlspecialchars($studio_name) 사용
   - 악의적인 HTML/JavaScript 코드 실행 방지

========================================
데이터베이스 쿼리 설명:
========================================
- m.studioname = '$studio_name2': 특정 스튜디오 필터링
- m.producerno = e.certno: 제작자 정보 조인
- ORDER BY m.year, m.title: 연도순, 제목순 정렬
- 시간 복잡도: O(n) (인덱스 사용 시 최적화 가능)

========================================
-->
