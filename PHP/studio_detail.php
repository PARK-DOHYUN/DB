<?php
// ========================================
// studio_detail.php: 특정 스튜디오의 상세 정보 표시
// ========================================
// 목적: 2.php에서 전달받은 스튜디오 이름으로
//       해당 스튜디오의 상세 정보(이름, 주소, 사장 정보) 표시
// 접근 방법: 2.php의 "영화사" 이름 링크 클릭 시 이동
// URL 형식: studio_detail.php?name=스튜디오이름
// ========================================

// ===== 한글 인코딩 설정 (선택사항) =====
// Oracle 데이터베이스의 한글 데이터를 올바르게 처리하기 위한 환경 변수
//putenv("NLS_LANG=KOREAN_KOREA.AL32UTF8");

// ===== 에러 처리 함수 =====
/**
 * Oracle 에러 메시지를 출력하고 스크립트 종료
 * 
 * @param resource|null $id - OCI 리소스 핸들 (connection 또는 statement)
 *                           null인 경우 전역 에러 확인
 */
function p_error($id=null){
    if($id == null) 
        $e = oci_error();      // 전역 에러 (주로 연결 실패)
    else 
        $e = oci_error($id);   // 특정 리소스의 에러 (파싱, 실행 실패 등)
    
    // HTML 특수문자를 엔티티로 변환하여 안전하게 출력
    print htmlentities($e['message']);
    exit();  // 스크립트 즉시 종료
}

// ===== 데이터베이스 연결 =====
// Oracle 데이터베이스에 연결
$conn = oci_connect("db2021663028","db88602924", "localhost/lecture");

// 연결 실패 시 에러 처리
if(!$conn) p_error();

// ===== GET 파라미터 수신 =====
// URL에서 전달된 스튜디오 이름 가져오기
// 예: studio_detail.php?name=Universal → $_GET["name"] = "Universal"
$studio_name = $_GET["name"];

// ===== SQL 인젝션 방지 처리 =====
// 스튜디오 이름에 작은따옴표(')가 있는 경우 두 개('')로 이스케이프
// 예: "Warner's" → "Warner''s"
// 이유: SQL 쿼리에서 문자열을 작은따옴표로 감싸므로 충돌 방지
// 중요: SQL 인젝션 공격 방지
$studio_name2 = str_replace("'", "''", $studio_name);

// ===== 스튜디오 상세 정보 조회 쿼리 =====
$stmt = oci_parse($conn,
    // SELECT 절: 
    //   - 스튜디오 정보: 이름, 주소
    //   - 사장 정보: 이름, 주소, 재산
    "select s.name, s.address, e.name boss, e.address boss_addr, e.networth ".
    // FROM 절: studio와 movieexec(사장) 테이블 조인
    "from studio s, movieexec e ".
    // WHERE 절:
    //   1. 특정 스튜디오 필터링
    //   2. 사장 정보 조인 (presno = certno)
    "where s.name = '$studio_name2' ".
    "and s.presno = e.certno");

// 파싱 실패 시 에러 처리
if(!$stmt) p_error($conn);

// ===== 쿼리 실행 =====
$r = oci_execute($stmt);

// 실행 실패 시 에러 처리
if(!$r) p_error($conn);

// ===== 페이지 제목 출력 =====
print "<h2>영화사 상세 정보</h2>\n";

// ===== 스튜디오 정보 출력 =====
// 쿼리 결과가 있는지 확인하고 첫 번째 행 가져오기
if($row = oci_fetch_array($stmt)){
    // 스튜디오 정보가 존재하는 경우
    
    // ----- HTML 테이블 시작 -----
    // 핑크색 배경, 1픽셀 테두리, 3픽셀 셀 간격
    print "<TABLE bgcolor='pink' border=1 cellspacing=3>\n";
    
    // ----- 각 정보를 행으로 출력 -----
    
    // 1. 영화사 이름 (빨간색 배경)
    // $row[0]: 스튜디오 이름
    print "<TR bgcolor='red'><TH>영화사 이름<TD>{$row[0]}</TR>\n";
    
    // 2. 영화사 주소 (핑크색 배경)
    // $row[1]: 스튜디오 주소
    print "<TR><TH bgcolor='pink'>주소<TD>{$row[1]}</TR>\n";
    
    // 3. 사장 이름 (핑크색 배경)
    // $row[2]: 사장 이름
    print "<TR bgcolor='pink'><TH>사장<TD>{$row[2]}</TR>\n";
    
    // 4. 사장 주소 (핑크색 배경)
    // $row[3]: 사장 주소
    print "<TR><TH bgcolor='pink'>사장 주소<TD>{$row[3]}</TR>\n";
    
    // 5. 사장 재산 (핑크색 배경)
    // $row[4]: 사장 재산액
    // number_format(): 천단위 구분 기호(,) 추가
    // 예: 50000000 → 50,000,000
    print "<TR bgcolor='pink'><TH>재산액수<TD>".number_format($row[4])."원</TR>\n";
    
    // ----- 테이블 종료 -----
    print "</TABLE>\n";
}
// else 블록 없음: 스튜디오가 없는 경우 아무것도 출력하지 않음
// (실제 운영 환경에서는 "존재하지 않는 스튜디오입니다" 메시지 권장)

// ===== 리소스 정리 =====
// 쿼리 리소스 해제
oci_free_statement($stmt);

// 데이터베이스 연결 종료
oci_close($conn);

?>

<!-- 
========================================
페이지 출력 예시:
========================================

영화사 상세 정보

+---------------+---------------------------+
| 영화사 이름   | Universal Studios         |
+---------------+---------------------------+
| 주소          | 100 Universal City Plaza |
+---------------+---------------------------+
| 사장          | Jeff Shell                |
+---------------+---------------------------+
| 사장 주소     | Los Angeles, CA           |
+---------------+---------------------------+
| 재산액수      | 50,000,000원              |
+---------------+---------------------------+

========================================
페이지 흐름:
========================================

[2.php - 메인 페이지]
    ↓ (스튜디오 이름 클릭)
[studio_detail.php] ← 현재 페이지
    - URL: ?name=스튜디오이름
    - 해당 스튜디오의 상세 정보 표시

========================================
주요 기능:
========================================
1. GET 파라미터로 스튜디오 이름 수신
2. 스튜디오 기본 정보 표시 (이름, 주소)
3. 사장 정보 표시 (이름, 주소, 재산)
4. 재산액에 천단위 구분 기호 추가 (number_format)
5. SQL 인젝션 방지 처리
6. 수직 테이블 레이아웃 (라벨-값 쌍)

========================================
테이블 레이아웃 특징:
========================================
- 각 정보를 별도의 행으로 표시
- 좌측 셀(TH): 라벨 (예: "영화사 이름")
- 우측 셀(TD): 값 (예: "Universal Studios")
- 읽기 쉽고 정보가 명확함
- 모바일 친화적 레이아웃

========================================
number_format() 함수:
========================================
- 목적: 숫자를 천단위로 구분하여 가독성 향상
- 입력: 50000000
- 출력: "50,000,000"
- 추가 파라미터 가능:
  * number_format($num, 소수점자리수)
  * number_format($num, 소수점, 소수점구분자, 천단위구분자)
  * 예: number_format(1234.56, 2, '.', ',') → "1,234.56"

========================================
보안 고려사항:
========================================
1. SQL 인젝션 방지:
   - str_replace("'", "''", $studio_name)
   - 작은따옴표 이스케이프 처리
   
2. 향후 개선 권장사항:
   - Prepared Statement 사용
   - XSS 방지: htmlspecialchars() 사용
   - 존재하지 않는 스튜디오 처리 추가

3. 에러 처리 개선:
   - 스튜디오가 없는 경우 적절한 메시지 표시
   - 예: if(!$row) { print "스튜디오를 찾을 수 없습니다."; }

========================================
데이터베이스 쿼리 설명:
========================================
- s.name = '$studio_name2': 특정 스튜디오 필터링
- s.presno = e.certno: 사장 정보 조인
  * presno: 사장의 인증번호 (studio 테이블)
  * certno: 임원의 인증번호 (movieexec 테이블)
- 조인 결과: 스튜디오 + 사장의 통합 정보

========================================
HTML 색상 구조:
========================================
- 첫 번째 행 (영화사 이름): 빨간색 (강조)
- 나머지 행: 핑크색 (일관성)
- TH 셀: 라벨용, 굵은 글씨
- TD 셀: 데이터용, 일반 글씨

========================================
-->
